---
layout: post
title: "xv6-源码解析-Trap"
category: os-6s081-source
---

6.s081 xv6-Trap实现

# xv6-源码解析-Trap

实现安全和隔离

## 几个关键的寄存器

PC 指向用户指令

SATP 指向pageTable（内核或用户进程）

STVEC 指向内核处理trap指令的起始地址

SEPC 保存在trap时PC

SSRATCH  用来交换两个值

**Supervisor模式能操作的寄存器和内容**

SATP 

STVEC S

EPC 

SSCRATC 

能使用PTC_U=0的PTE

## Trap过程

例如调用 

用户

write()函数，再调用 ecall 指令                         ↑

1↓                                                                          ↑（回到ecall）

进入内核                                                               ↑

汇编函数uservec(trampoline.s一部分)         userret（）

2↓             							      ↑

调用usertrap()                                        	usertrapret()部分工作通过汇编实现

3↓           								↑

调用syscall()

4↓           ↑

调用sys_write();







